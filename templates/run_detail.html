{% extends "base.html" %}

{% block title %}Запуск #{{ batch.id }} — История пакетной оценки{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-2">Детальный просмотр пакетного запуска</h1>
        <p class="text-muted mb-1">
            Здесь представлены клиенты, для которых в рамках выбранного запуска были рассчитаны
            вероятность конверсии, приоритетный сегмент и поведенческий кластер.
        </p>
        <p class="small text-muted mb-0">
            Отображается не более 500 наиболее «горячих» клиентов, отсортированных по убыванию скорингового балла.
            Полная выгрузка доступна в виде CSV-файла.
        </p>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Информация о запуске</h5>

                <p class="mb-1">
                    <span class="fw-semibold">ID запуска:</span> {{ batch.id }}
                </p>
                <p class="mb-1">
                    <span class="fw-semibold">Название:</span> {{ batch.name }}
                </p>
                <p class="mb-1 text-muted small">
                    Дата и время: {{ batch.created_at.strftime("%d.%m.%Y %H:%M") }}
                </p>
                <p class="mb-1">
                    Клиентов в наборе:
                    <strong>{{ batch.n_clients or leads|length }}</strong><br>
                    Средний скор модели:
                    <strong>{{ "%.3f"|format(batch.avg_score or 0) }}</strong><br>
                    Доля предсказанных конверсий:
                    <strong>{{ "%.1f"|format((batch.avg_predicted_conversion or 0) * 100) }}%</strong><br>
                    Порог классификации:
                    <strong>{{ "%.3f"|format(batch.threshold_used or ml_service.default_threshold) }}</strong>
                </p>

                <div class="mt-3">
                    <a href="{{ url_for('download_run', run_id=batch.id) }}"
                       class="btn btn-sm btn-outline-success me-2">
                        Скачать результаты (CSV)
                    </a>
                    <a href="{{ url_for('runs_list') }}"
                       class="btn btn-sm btn-outline-secondary">
                        Назад к списку запусков
                    </a>
                </div>

                {% if batch.comment %}
                    <hr class="mt-3 mb-2">
                    <h6 class="fw-semibold">Комментарий к запуску</h6>
                    <p class="small mb-0">{{ batch.comment }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">
                        Клиенты в рамках запуска
                    </h5>
                    <span class="badge bg-light text-muted border small">
                        Показано записей: {{ leads|length }} из {{ batch.n_clients or leads|length }}
                    </span>
                </div>

                {% if leads and leads|length > 0 %}
                    <p class="small text-muted">
                        Клиенты отсортированы по скоринговому баллу модели (столбец
                        <code>rf_score</code>) от самых перспективных к менее перспективным.
                        Цветовое выделение отражает приоритетный сегмент.
                    </p>

                    <div class="table-responsive small">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Клиент</th>
                                <th>Канал / Тип кампании</th>
                                <th class="text-end">Скор модели</th>
                                <th>Сегмент</th>
                                <th>Кластер</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for lead in leads %}
                                <tr>
                                    <td class="text-muted">{{ lead.id }}</td>
                                    <td>
                                        <div class="fw-semibold">
                                            {{ lead.customer_id or "без идентификатора" }}
                                        </div>
                                        <div class="text-muted">
                                            Возраст: {{ lead.age or "—" }},
                                            {{ "М" if lead.gender == "Male" else "Ж" if lead.gender == "Female" else "пол не указан" }},
                                            доход: {{ "%.0f"|format(lead.income or 0) }} ₽
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <span class="badge bg-outline-dark bg-light text-dark border">
                                                {{ lead.campaign_channel or "канал не указан" }}
                                            </span>
                                        </div>
                                        <div class="text-muted small">
                                            {{ lead.campaign_type or "тип кампании не указан" }}
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        {{ "%.3f"|format(lead.rf_score or 0) }}<br>
                                        <span class="text-muted small">
                                            {% if lead.predicted_conversion == 1 %}
                                                прогноз: конверсия
                                            {% else %}
                                                прогноз: нет конверсии
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if lead.priority_segment == 'High' %}
                                            <span class="badge bg-success">High</span>
                                            <span class="ms-1 text-muted small">высокий приоритет</span>
                                        {% elif lead.priority_segment == 'Medium' %}
                                            <span class="badge bg-warning text-dark">Medium</span>
                                            <span class="ms-1 text-muted small">средний приоритет</span>
                                        {% elif lead.priority_segment == 'Low' %}
                                            <span class="badge bg-secondary">Low</span>
                                            <span class="ms-1 text-muted small">низкий приоритет</span>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                        <div class="text-muted small">
                                            дециль: {{ lead.rf_decile or "—" }} из 10
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info text-dark">
                                            Кластер {{ lead.cluster_kmeans if lead.cluster_kmeans is not none else "—" }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <a href="{{ url_for('client_detail', lead_id=lead.id) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            Карточка
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">
                        В рамках этого запуска не найдено ни одного клиента. Возможно, импорт CSV-файла завершился
                        с ошибкой или данные были очищены.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}