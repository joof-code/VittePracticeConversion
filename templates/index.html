{% extends "base.html" %}

{% block title %}Дашборд — Система повышения конверсии{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-3">Дашборд по конверсии клиентов</h1>
        <p class="text-muted">
            Здесь отображается сводная информация по уже обработанным клиентам и пакетным запускам.
            Данные используются в учебных целях для иллюстрации работы интеллектуальной системы.
        </p>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Всего клиентов в базе</h5>
                <p class="display-6 mb-0">
                    {{ total_leads or 0 }}
                </p>
                <p class="text-muted small mt-2">
                    Количество записей, по которым уже было выполнено прогнозирование конверсии.
                </p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Пакетные запуски (CSV)</h5>
                <p class="display-6 mb-0">
                    {{ total_batches or 0 }}
                </p>
                <p class="text-muted small mt-2">
                    Число загрузок CSV-файлов с лидами, для которых система рассчитала прогнозы.
                </p>
                <a href="{{ url_for('upload_batch') }}" class="btn btn-sm btn-outline-primary mt-2">
                    Новый пакетный запуск
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Последний пакетный запуск</h5>

                {% if last_batch %}
                    <p class="mb-1 fw-semibold">
                        {{ last_batch.name }}
                    </p>
                    <p class="mb-1 text-muted small">
                        Дата: {{ last_batch.created_at.strftime("%d.%m.%Y %H:%M") }}
                    </p>
                    <p class="mb-1">
                        Клиентов: <strong>{{ last_batch.n_clients }}</strong><br>
                        Средний скор: <strong>{{ "%.3f"|format(last_batch.avg_score or 0) }}</strong><br>
                        Доля предсказанных конверсий:
                        <strong>{{ "%.1f"|format((last_batch.avg_predicted_conversion or 0) * 100) }}%</strong>
                    </p>
                    <a href="{{ url_for('run_detail', run_id=last_batch.id) }}"
                       class="btn btn-sm btn-outline-secondary mt-2">
                        Открыть запуск
                    </a>
                {% else %}
                    <p class="text-muted">
                        Пока нет ни одного пакетного запуска. Загрузите CSV-файл с лидами,
                        чтобы увидеть здесь статистику.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12 col-lg-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Распределение клиентов по приоритетным сегментам</h5>

                {% if segment_stats and segment_stats|length > 0 %}
                    <p class="text-muted small">
                        Сегменты формируются на основе децильной оценки по вероятности конверсии.
                        <strong>High</strong> — самые перспективные клиенты, <strong>Low</strong> — низкий приоритет.
                    </p>

                    <table class="table table-sm align-middle mb-0">
                        <thead>
                        <tr>
                            <th>Сегмент</th>
                            <th>Количество клиентов</th>
                            <th>Средний скор модели</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in segment_stats %}
                            <tr>
                                <td>
                                    {% if row.segment == 'High' %}
                                        <span class="badge bg-success">High</span>
                                        <span class="ms-1 text-muted small">высокий приоритет</span>
                                    {% elif row.segment == 'Medium' %}
                                        <span class="badge bg-warning text-dark">Medium</span>
                                        <span class="ms-1 text-muted small">средний приоритет</span>
                                    {% elif row.segment == 'Low' %}
                                        <span class="badge bg-secondary">Low</span>
                                        <span class="ms-1 text-muted small">низкий приоритет</span>
                                    {% else %}
                                        {{ row.segment }}
                                    {% endif %}
                                </td>
                                <td>{{ row.n }}</td>
                                <td>{{ "%.3f"|format(row.avg_score or 0) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">
                        Данных для формирования сегментов пока нет. Выполните хотя бы одну оценку клиента
                        или пакетный запуск.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6 mb-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Как пользоваться системой</h5>
                <ol class="small mb-2">
                    <li>
                        Перейдите во вкладку <strong>«Оценить клиента»</strong> и заполните форму
                        для одиночного потенциального клиента. Система покажет вероятность конверсии,
                        приоритетный сегмент и краткую интерпретацию результата.
                    </li>
                    <li>
                        Для обработки большого числа клиентов используйте вкладку
                        <strong>«Пакетная оценка (CSV)»</strong>. Загрузите файл, совместимый
                        с учебным датасетом, и получите прогноз для всей выборки.
                    </li>
                    <li>
                        Во вкладке <strong>«История запусков»</strong> можно вернуться
                        к прошлым расчётам, просмотреть их детально и выгрузить результаты в CSV.
                    </li>
                </ol>
                <p class="text-muted small mb-0">
                    Вся логика прогнозирования реализована на основе предварительно обученной модели
                    (RandomForest) и сегментации клиентов (децили и кластеры). Реальная бизнес-логика
                    может быть адаптирована под особенности конкретной компании.
                </p>
            </div>
        </div>
    </div>
</div>

{% endblock %}